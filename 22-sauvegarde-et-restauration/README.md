üîù Retour au [Sommaire](/SOMMAIRE.md)

# 22. Sauvegarde et Restauration

## Introduction au chapitre

Bienvenue dans l'un des chapitres les plus importants de cette formation : la **sauvegarde et la restauration**. Si vous ne deviez retenir qu'une seule chose de ce cours, ce serait celle-ci : **vos donn√©es sont pr√©cieuses, et sans sauvegarde, vous jouez √† la roulette russe avec votre infrastructure**.

### Pourquoi ce chapitre est crucial

Imaginez cette situation (malheureusement trop courante) :

```
Vendredi soir, 23h45 : Vous d√©ployez une mise √† jour sur votre cluster MicroK8s
Samedi matin, 2h00 : R√©veil brutal - le serveur ne r√©pond plus
Samedi matin, 2h15 : Panique - impossible de red√©marrer le cluster
Samedi matin, 2h30 : Question fatidique : "O√π est ma derni√®re sauvegarde ?"
Samedi matin, 2h31 : R√©ponse terrifiante : "Euh... quelle sauvegarde ?"

R√©sultat : Week-end ruin√© √† essayer de reconstruire tout √† partir de z√©ro.
Perte de donn√©es : 3 mois de travail.
Le√ßon apprise : √Ä un prix tr√®s √©lev√©.
```

Maintenant, imaginez le m√™me sc√©nario **avec une strat√©gie de sauvegarde solide** :

```
Vendredi soir, 23h45 : Vous d√©ployez une mise √† jour
Samedi matin, 2h00 : Le serveur ne r√©pond plus
Samedi matin, 2h05 : Vous ouvrez votre documentation de restauration
Samedi matin, 2h10 : Vous lancez la restauration depuis le backup de la veille
Samedi matin, 3h30 : Le cluster est restaur√©, tout fonctionne
Samedi matin, 3h45 : Vous retournez vous coucher

R√©sultat : Incident g√©r√© calmement.
Perte de donn√©es : Quelques heures au maximum.
Le√ßon apprise : Votre strat√©gie de sauvegarde vaut son pesant d'or.
```

La diff√©rence entre ces deux sc√©narios ? **Ce chapitre.**

### Les trois v√©rit√©s sur les sauvegardes

Avant d'entrer dans les d√©tails, comprenons trois v√©rit√©s fondamentales :

#### V√©rit√© #1 : Ce n'est pas "si" mais "quand"

**La question n'est pas de savoir SI vous aurez un probl√®me, mais QUAND.**

Les d√©sastres arrivent √† tout le monde :
- Erreur humaine : Vous supprimez accidentellement un namespace important
- D√©faillance mat√©rielle : Un disque dur l√¢che sans pr√©venir
- Bug logiciel : Une mise √† jour corrompt votre cluster
- Cyberattaque : Un ransomware chiffre vos donn√©es
- Catastrophe naturelle : Inondation, incendie, panne √©lectrique majeure

M√™me les g√©ants de la tech perdent des donn√©es. La diff√©rence ? Ils ont des sauvegardes.

#### V√©rit√© #2 : Une sauvegarde non test√©e n'est pas une sauvegarde

Avoir des backups ne suffit pas. Vous devez **prouver** que vous pouvez restaurer depuis ces backups.

Histoire vraie et trop commune :
```
Entreprise : "Nous avons des backups quotidiens depuis 2 ans !"
Incident : Serveur HS, restauration n√©cessaire
Tentative : √âchec - les backups sont corrompus depuis 6 mois
R√©alisation : Personne n'avait jamais test√© la restauration
```

**La r√®gle d'or** : Si vous n'avez jamais restaur√© depuis un backup, vous n'avez pas de backup, juste l'illusion d'en avoir.

#### V√©rit√© #3 : Les sauvegardes sont une assurance, pas un co√ªt

Beaucoup voient les sauvegardes comme une d√©pense :
- "√áa prend de l'espace disque"
- "√áa ralentit le syst√®me"
- "Je n'ai pas le temps de configurer √ßa"
- "Mon cluster est simple, je peux tout reconfigurer"

**Changez de perspective** : Les sauvegardes sont une **assurance**.

Vous payez une petite prime (espace disque, temps de configuration) pour vous prot√©ger contre une perte catastrophique (des semaines de travail, des donn√©es irrempla√ßables, votre r√©putation).

Analogie simple : Vous ne conduisez pas sans assurance automobile. Pourquoi faire tourner un cluster sans "assurance donn√©es" ?

### Ce que vous allez apprendre

Ce chapitre complet couvre **tous les aspects** de la sauvegarde et restauration pour MicroK8s, du niveau d√©butant √† expert.

#### Section 22.1 : Strat√©gies de sauvegarde

Avant de sauvegarder, il faut **comprendre ce qu'on sauvegarde et pourquoi**.

**Vous apprendrez** :
- Quels sont les diff√©rents types de sauvegardes (compl√®te, incr√©mentale, diff√©rentielle)
- Comment choisir la bonne strat√©gie pour votre cas d'usage
- La r√®gle 3-2-1 et pourquoi elle est essentielle
- D√©finir vos objectifs RPO (Recovery Point Objective) et RTO (Recovery Time Objective)
- Quelle fr√©quence de sauvegarde choisir selon vos besoins

**Analogie** : Avant de construire une maison, vous faites des plans. Cette section, ce sont vos plans pour prot√©ger vos donn√©es.

#### Section 22.2 : Sauvegarde avec Velero

**Velero** est l'outil de r√©f√©rence pour sauvegarder et restaurer des clusters Kubernetes. C'est comme avoir un "bouton magique" pour capturer et restaurer tout votre cluster.

**Vous apprendrez** :
- Qu'est-ce que Velero et pourquoi c'est l'outil id√©al
- Comment installer Velero sur MicroK8s
- Configurer MinIO comme stockage de backups (solution locale gratuite)
- Cr√©er votre premi√®re sauvegarde
- Restaurer depuis une sauvegarde
- Planifier des sauvegardes automatiques

**√Ä la fin de cette section**, vous pourrez sauvegarder et restaurer votre cluster en quelques commandes.

#### Section 22.3 : Configuration Velero

Passer du backup de base √† une configuration professionnelle et optimis√©e.

**Vous apprendrez** :
- Configurer finement les BackupStorageLocations
- G√©rer les credentials de mani√®re s√©curis√©e
- Configurer Restic/Kopia pour la sauvegarde des volumes
- Mettre en place des exclusions intelligentes
- Optimiser les performances
- Configurer plusieurs destinations de backup
- S√©curiser vos sauvegardes

**Cette section transforme** un syst√®me fonctionnel en syst√®me professionnel.

#### Section 22.4 : Snapshots de volumes

Les **snapshots** sont comme des "photos instantan√©es" de vos disques. Ultra-rapides, mais n√©cessitent un stockage compatible.

**Vous apprendrez** :
- La diff√©rence entre snapshots et backups par fichier
- Comment fonctionnent les snapshots (Copy-on-Write)
- Installer le support des snapshots sur MicroK8s (OpenEBS, Longhorn)
- Cr√©er et g√©rer des snapshots de volumes
- Restaurer depuis un snapshot
- Utiliser les snapshots pour cloner rapidement des environnements
- Quand utiliser snapshots vs Restic/Kopia

**Important pour MicroK8s** : Par d√©faut, le stockage hostpath ne supporte pas les snapshots natifs. Cette section explique les alternatives et quand elles valent la peine.

#### Section 22.5 : Export/Import de configurations

Le **GitOps avant la lettre** : sauvegarder vos configurations dans des fichiers YAML versionn√©s.

**Vous apprendrez** :
- Exporter toutes vos ressources Kubernetes en YAML
- Nettoyer les m√©tadonn√©es pour r√©import
- Organiser vos exports (par namespace, par application, par type)
- Importer des configurations dans un nouveau cluster
- Migration entre clusters
- Versionner vos configurations dans Git
- Utiliser Kustomize et Helm pour la r√©utilisabilit√©
- Introduction au GitOps (ArgoCD, Flux)

**Cette approche** compl√®te parfaitement Velero : elle capture la configuration, Velero capture les donn√©es.

#### Section 22.6 : Tests de restauration

La section la plus importante apr√®s avoir configur√© vos backups.

**Vous apprendrez** :
- Pourquoi tester est absolument critique
- Les diff√©rents types de tests (validation, partiel, complet)
- Cr√©er des environnements de test
- M√©thodologie de test en 5 phases
- Planifier des tests r√©guliers (calendrier mensuel/trimestriel)
- Mesurer vos m√©triques (RTO r√©el, taux de r√©ussite)
- Documenter vos tests
- Automatiser les tests avec des scripts

**Le principe fondamental** : Une sauvegarde non test√©e = pas de sauvegarde.

#### Section 22.7 : Plan de reprise d'activit√© (DRP)

Le **DRP** (Disaster Recovery Plan) est votre manuel de survie quand tout va mal. C'est le document que vous ouvrez √† 3h du matin quand le serveur est en panne.

**Vous apprendrez** :
- Qu'est-ce qu'un DRP et pourquoi c'est essentiel
- D√©finir vos RPO et RTO par application
- Structure compl√®te d'un DRP (9 sections)
- √âcrire des proc√©dures d√©taill√©es √©tape par √©tape
- G√©rer diff√©rents sc√©narios de d√©sastre (incident mineur √† catastrophe majeure)
- Organiser les contacts et l'escalade
- Tester r√©guli√®rement votre DRP
- Am√©lioration continue avec post-mortems

**√Ä la fin**, vous aurez un document complet qui vous guide pr√©cis√©ment pour chaque type d'incident.

#### Section 22.8 : Automatisation des sauvegardes

Passer d'un syst√®me qui d√©pend de votre m√©moire √† un syst√®me qui fonctionne tout seul.

**Vous apprendrez** :
- Les niveaux d'automatisation (de 20% √† 95%)
- Automatiser avec Cron (planificateur Linux classique)
- Automatiser avec Systemd Timers (approche moderne)
- Utiliser les Velero Schedules (natif Kubernetes)
- Automatiser la v√©rification des backups
- Nettoyage automatique des anciens backups
- Notifications automatiques (email, Slack, Discord)
- Monitoring avec Prometheus et Grafana
- Orchestration compl√®te du workflow
- Bonnes pratiques d'automatisation

**L'objectif** : Cr√©er un syst√®me qui sauvegarde, v√©rifie, nettoie et alerte automatiquement pendant que vous dormez tranquille.

### Pr√©requis pour ce chapitre

Ce chapitre est accessible si vous avez :

**Connaissances techniques** :
- ‚úÖ Bases de Kubernetes (Pods, Deployments, Services, PVCs)
- ‚úÖ Utilisation de kubectl
- ‚úÖ MicroK8s install√© et fonctionnel
- ‚úÖ Notions de ligne de commande Linux
- ‚úÖ (Optionnel) Git pour le versionnement

**Environnement** :
- ‚úÖ Cluster MicroK8s op√©rationnel
- ‚úÖ Acc√®s root ou sudo sur le serveur
- ‚úÖ Espace disque disponible pour les backups (minimum 50 GB recommand√©)
- ‚úÖ (Optionnel) Compte cloud pour stockage distant (AWS S3, etc.)

**Pas de panique si vous d√©butez** : Ce chapitre est con√ßu pour √™tre accessible. Chaque concept est expliqu√© avec des analogies et des exemples concrets.

### Philosophie de ce chapitre

Ce chapitre suit trois principes directeurs :

#### 1. Simplicit√© d'abord, complexit√© ensuite

Nous commen√ßons toujours par la solution la plus simple qui fonctionne, puis nous ajoutons de la sophistication progressivement.

**Exemple** :
- Section 22.2 : Backup Velero de base (30 minutes √† mettre en place)
- Section 22.3 : Configuration avanc√©e (quelques heures)
- Section 22.8 : Orchestration compl√®te (syst√®me professionnel)

Vous pouvez vous arr√™ter √† n'importe quel niveau selon vos besoins.

#### 2. Pratique avant th√©orie

Chaque section contient des **exemples concrets** et des **commandes pr√™tes √† utiliser**.

Vous n'aurez pas juste la th√©orie, vous aurez :
- Scripts complets et comment√©s
- Commandes exactes √† ex√©cuter
- Exemples de fichiers de configuration
- Proc√©dures √©tape par √©tape

L'objectif : vous pouvez suivre le chapitre et avoir un syst√®me fonctionnel √† la fin.

#### 3. Tests, tests, tests

Nous insistons **lourdement** sur l'importance des tests.

Chaque section inclut :
- Comment tester que √ßa fonctionne
- Comment v√©rifier que tout est OK
- Comment d√©tecter les probl√®mes

**Pourquoi ?** Parce qu'un backup non test√© ne vaut rien.

### Comment utiliser ce chapitre

#### Si vous partez de z√©ro

**Parcours recommand√©** (2-3 jours) :

1. **Jour 1 - Fondations** :
   - Lire 22.1 (Strat√©gies) pour comprendre l'approche
   - Suivre 22.2 (Velero) pour installer et cr√©er votre premier backup
   - Tester la restauration basique

2. **Jour 2 - Consolidation** :
   - Approfondir avec 22.3 (Configuration Velero)
   - D√©couvrir 22.5 (Export/Import) pour Git
   - Faire un premier test de restauration (22.6)

3. **Jour 3 - Automatisation** :
   - Mettre en place l'automatisation (22.8)
   - Cr√©er un DRP minimal (22.7)
   - Valider que tout fonctionne

**Temps total estim√©** : 15-20 heures pour un syst√®me complet et test√©.

#### Si vous avez d√©j√† des backups

**Parcours d'am√©lioration** :

1. Lisez 22.6 (Tests) et **testez vos backups existants** imm√©diatement
2. √âvaluez votre strat√©gie actuelle avec 22.1
3. Am√©liorez la configuration avec 22.3
4. Automatisez avec 22.8
5. Cr√©ez/am√©liorez votre DRP avec 22.7

**Focus prioritaire** : Les tests. Si vous n'avez jamais test√© une restauration, faites-le avant toute autre chose.

#### Si vous g√©rez un environnement critique

**Parcours professionnel** :

1. Lisez tout le chapitre pour avoir la vue d'ensemble
2. D√©finissez pr√©cis√©ment vos RPO/RTO (22.1 et 22.7)
3. Impl√©mentez une solution robuste (22.2, 22.3, 22.4)
4. Cr√©ez un DRP complet et d√©taill√© (22.7)
5. Testez r√©guli√®rement et intens√©ment (22.6)
6. Automatisez tout (22.8)
7. Monitoring et am√©lioration continue

**Temps total** : 1-2 semaines pour un syst√®me de niveau production.

### Structure des sections

Chaque section suit la m√™me structure pour faciliter la navigation :

```
üìò Introduction
   ‚îú‚îÄ Pourquoi cette section est importante
   ‚îú‚îÄ Analogies et exemples concrets
   ‚îî‚îÄ Ce que vous allez apprendre

üîß Concepts et th√©orie
   ‚îú‚îÄ Explications accessibles
   ‚îú‚îÄ Sch√©mas et illustrations
   ‚îî‚îÄ Comparaisons et choix

üíª Pratique et impl√©mentation
   ‚îú‚îÄ Installation √©tape par √©tape
   ‚îú‚îÄ Configuration comment√©e
   ‚îú‚îÄ Scripts et exemples
   ‚îî‚îÄ Commandes exactes

‚úÖ Tests et v√©rification
   ‚îú‚îÄ Comment tester
   ‚îú‚îÄ Que v√©rifier
   ‚îî‚îÄ D√©pannage courant

üìö Bonnes pratiques
   ‚îú‚îÄ Recommandations
   ‚îú‚îÄ Erreurs √† √©viter
   ‚îî‚îÄ Optimisations

üìã Checklist r√©capitulative
   ‚îî‚îÄ Points cl√©s √† retenir
```

### Les outils que vous allez utiliser

Ce chapitre se concentre principalement sur quelques outils essentiels :

#### Velero
**L'outil principal de ce chapitre.**
- D√©velopp√© par VMware
- Standard de facto pour Kubernetes
- Open source et mature
- Gratuit

#### MinIO
**Stockage objet pour vos backups.**
- Compatible S3
- Peut tourner localement
- Open source
- Alternative gratuite √† AWS S3

#### Restic/Kopia
**Sauvegarde des volumes.**
- Int√©gr√© √† Velero
- Fonctionne avec tout type de stockage
- Chiffrement natif
- Open source

#### Outils compl√©mentaires
- **kubectl** : Interaction avec Kubernetes
- **yq/jq** : Manipulation YAML/JSON
- **Cron/Systemd** : Automatisation
- **Git** : Versionnement des configs
- **Prometheus/Grafana** : Monitoring

**Tous ces outils sont gratuits et open source.**

### √Ä propos des exercices pratiques

**Important** : Ce chapitre ne contient volontairement pas d'exercices pratiques s√©par√©s.

**Pourquoi ?**

Parce que chaque section est **d√©j√† un exercice pratique** en elle-m√™me. Les exemples et commandes fournis sont con√ßus pour √™tre ex√©cut√©s directement sur votre syst√®me.

**Notre approche** :
1. Vous lisez la th√©orie
2. Vous suivez les exemples concrets
3. Vous testez sur votre cluster
4. Vous adaptez √† vos besoins

C'est un apprentissage par la pratique directe plut√¥t que par des exercices th√©oriques.

### Avertissements et pr√©cautions

#### ‚ö†Ô∏è Testez sur un environnement de lab d'abord

Si vous g√©rez un cluster de production, **ne testez PAS directement en production**.

**Recommandation** :
1. Installez un second MicroK8s de test
2. Pratiquez toutes les op√©rations
3. Une fois √† l'aise, appliquez en production
4. Toujours faire un backup avant de tester une restauration

#### ‚ö†Ô∏è Les sauvegardes contiennent des donn√©es sensibles

Vos backups contiennent :
- Secrets Kubernetes (mots de passe, cl√©s API)
- Certificats SSL/TLS
- Donn√©es applicatives

**S√©curisez-les** :
- Chiffrez les backups
- Contr√¥lez les acc√®s
- Ne les partagez pas publiquement
- Stockez-les dans un endroit s√ªr

#### ‚ö†Ô∏è L'espace disque

Les backups prennent de la place, surtout si vous avez beaucoup de volumes.

**Planifiez** :
- Minimum 50 GB d'espace pour les backups
- Plus si vous avez des volumes volumineux
- Surveillez l'utilisation
- Mettez en place une rotation

#### ‚ö†Ô∏è La restauration peut √©craser des donn√©es

Une restauration **remplace** les ressources existantes.

**Soyez prudent** :
- Comprenez ce que vous faites
- Testez d'abord dans un namespace temporaire
- Ayez toujours un backup de l'√©tat actuel
- Documentez vos actions

### Messages cl√©s √† retenir

Avant d'entrer dans les d√©tails techniques, retenez ces principes fondamentaux :

1. **Les d√©sastres arrivent √† tout le monde** - Pas de "si" mais "quand"

2. **Une sauvegarde non test√©e n'est pas une sauvegarde** - Testez r√©guli√®rement

3. **La simplicit√© est une vertu** - Commencez simple, complexifiez si n√©cessaire

4. **L'automatisation est essentielle** - Vous oublierez, un script jamais

5. **Documentez tout** - Future vous remerciera pr√©sent vous

6. **3-2-1 est votre ami** - 3 copies, 2 supports, 1 hors site

7. **RPO et RTO guident vos choix** - D√©finissez-les clairement

8. **Le backup n'est que la moiti√©** - La restauration est aussi importante

### Motivation finale

Configurer des sauvegardes n'est pas le travail le plus excitant. Ce n'est pas aussi cool que de d√©ployer une nouvelle application brillante ou de mettre en place un cluster Kubernetes complexe.

**Mais c'est l'un des investissements les plus importants que vous ferez.**

Pensez-y comme √† une **assurance peace-of-mind** :
- Vous pouvez exp√©rimenter sans peur
- Vous pouvez dormir tranquille
- Vous pouvez g√©rer les incidents calmement
- Vous prot√©gez des mois de travail

Un jour, vous serez content d'avoir lu ce chapitre. Peut-√™tre m√™me tr√®s, tr√®s content.

### Pr√™t √† commencer ?

Ce chapitre est long (8 sections), mais chaque section est autonome. Vous pouvez :
- Le lire d'un bout √† l'autre
- Piocher les sections qui vous int√©ressent
- Y revenir comme r√©f√©rence

**Commen√ßons par le commencement** : Comprendre les strat√©gies de sauvegarde dans la section 22.1.

Mais avant, une derni√®re chose...

### La r√®gle d'or (√† ne jamais oublier)

> **"Le meilleur moment pour configurer vos sauvegardes √©tait hier. Le deuxi√®me meilleur moment est maintenant."**

N'attendez pas le d√©sastre pour r√©aliser que vous auriez d√ª avoir des backups.

**N'attendez pas. Commencez maintenant.**

---

*Vous √™tes maintenant pr√™t √† plonger dans le monde de la sauvegarde et restauration Kubernetes. Direction la section 22.1 pour d√©couvrir les strat√©gies de sauvegarde !*

‚è≠Ô∏è [Strat√©gies de sauvegarde](/22-sauvegarde-et-restauration/01-strategies-de-sauvegarde.md)
